<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICAN Weekly Scheduler</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        
        .header { 
            background: linear-gradient(135deg, #1e3a8a, #3b82f6); 
            color: white; 
            padding: 20px; 
            text-align: center; 
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .card { 
            background: white; 
            border-radius: 10px; 
            padding: 20px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
        }
        
        .btn { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px; 
            margin: 5px; 
        }
        
        .btn:hover { background: #2563eb; }
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        
        .status { 
            padding: 10px; 
            border-radius: 6px; 
            margin: 10px 0; 
        }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.info { background: #dbeafe; color: #1e40af; }
        
        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .time-slot {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 12px;
        }
        
        .loading { text-align: center; color: #6b7280; }
        .hidden { display: none; }
        
        pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        
        h1 { font-size: 2rem; margin-bottom: 10px; }
        h2 { color: #1f2937; margin-bottom: 15px; }
        h3 { color: #374151; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ ICAN Weekly Scheduler</h1>
        <p>30-Minute Time Slots ‚Ä¢ Weekly Recurring Schedules ‚Ä¢ Day-Specific Availability</p>
    </div>

    <div class="container">
        <!-- Backend Status -->
        <div class="card">
            <h2>üîß Backend Connection</h2>
            <button class="btn" onclick="testBackend()">Test Connection</button>
            <div id="backend-status"></div>
        </div>

        <!-- Weekly Templates -->
        <div class="card">
            <h2>üìÖ Weekly Templates</h2>
            <button class="btn btn-success" onclick="loadTemplates()">Load Templates</button>
            <button class="btn" onclick="createSampleTemplate()">Create Sample Template</button>
            <div id="templates-status"></div>
            <div id="templates-data" class="hidden"></div>
        </div>

        <!-- 30-Minute Time Slots -->
        <div class="card">
            <h2>‚è∞ 30-Minute Time Slots</h2>
            <button class="btn btn-success" onclick="loadTimeSlots()">Load Time Slots</button>
            <div id="timeslots-status"></div>
            <div id="timeslots-grid" class="time-slots-grid"></div>
        </div>

        <!-- Teachers Management -->
        <div class="card">
            <h2>üë®‚Äçüè´ Teachers</h2>
            <div class="grid">
                <div>
                    <h3>Add Teacher to Template</h3>
                    <input type="text" id="teacher-name" placeholder="Teacher Name" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px;">
                    <select id="teacher-day" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                        <option value="0">Sunday</option>
                    </select>
                    <button class="btn" onclick="addTeacher()">Add Teacher</button>
                </div>
                <div>
                    <h3>Teachers by Day</h3>
                    <select id="view-day" onchange="loadTeachersByDay()" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="">Select Day</option>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                        <option value="0">Sunday</option>
                    </select>
                    <div id="teachers-by-day"></div>
                </div>
            </div>
            <div id="teacher-status"></div>
        </div>

        <!-- Weekly Instance Generation -->
        <div class="card">
            <h2>‚ö° Generate Weekly Schedule</h2>
            <p>Generate actual teacher/student schedules for a specific week from the template.</p>
            <input type="date" id="week-date" style="padding: 8px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px;">
            <button class="btn btn-success" onclick="generateWeeklyInstance()">Generate This Week</button>
            <div id="instance-status"></div>
        </div>

        <!-- API Documentation -->
        <div class="card">
            <h2>üìö API Endpoints Available</h2>
            <div class="grid">
                <div>
                    <h3>Weekly Templates:</h3>
                    <ul style="margin-left: 20px; line-height: 1.6;">
                        <li>GET /api/weekly/templates</li>
                        <li>POST /api/weekly/templates</li>
                        <li>GET /api/weekly/templates/:id</li>
                    </ul>
                </div>
                <div>
                    <h3>Time & Rooms:</h3>
                    <ul style="margin-left: 20px; line-height: 1.6;">
                        <li>GET /api/timeslots (24 thirty-minute slots)</li>
                        <li>GET /api/rooms</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5555/api';
        let currentTemplateId = 1;

        // Set today's date as default
        document.getElementById('week-date').valueAsDate = new Date();

        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${url}`, {
                    headers: { 'Content-Type': 'application/json' },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                throw new Error(`API Error: ${error.message}`);
            }
        }

        async function testBackend() {
            const status = document.getElementById('backend-status');
            status.innerHTML = '<div class="status info">Testing connection...</div>';
            
            try {
                const data = await apiRequest('/health');
                status.innerHTML = `<div class="status success">‚úÖ Connected: ${data.message}</div>`;
            } catch (error) {
                status.innerHTML = `<div class="status error">‚ùå ${error.message}</div>`;
            }
        }

        async function loadTemplates() {
            const status = document.getElementById('templates-status');
            const data = document.getElementById('templates-data');
            
            status.innerHTML = '<div class="status info">Loading templates...</div>';
            
            try {
                const templates = await apiRequest('/weekly/templates');
                
                if (templates.length > 0) {
                    currentTemplateId = templates[0].id;
                    status.innerHTML = `<div class="status success">‚úÖ Found ${templates.length} template(s)</div>`;
                    data.innerHTML = `<pre>${JSON.stringify(templates, null, 2)}</pre>`;
                    data.classList.remove('hidden');
                } else {
                    status.innerHTML = '<div class="status error">No templates found. Create one first.</div>';
                }
            } catch (error) {
                status.innerHTML = `<div class="status error">‚ùå ${error.message}</div>`;
            }
        }

        async function createSampleTemplate() {
            const status = document.getElementById('templates-status');
            status.innerHTML = '<div class="status info">Creating sample template...</div>';
            
            try {
                const template = await apiRequest('/weekly/templates', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: 'Sample Weekly Template',
                        description: 'Example template with different schedules per day'
                    })
                });
                
                currentTemplateId = template.id;
                status.innerHTML = `<div class="status success">‚úÖ Created template: ${template.name}</div>`;
            } catch (error) {
                status.innerHTML = `<div class="status error">‚ùå ${error.message}</div>`;
            }
        }

        async function loadTimeSlots() {
            const status = document.getElementById('timeslots-status');
            const grid = document.getElementById('timeslots-grid');
            
            status.innerHTML = '<div class="status info">Loading 30-minute time slots...</div>';
            
            try {
                const slots = await apiRequest('/timeslots');
                
                if (slots.length === 24) {
                    status.innerHTML = `<div class="status success">‚úÖ Loaded ${slots.length} thirty-minute slots</div>`;
                    grid.innerHTML = slots.map(slot => 
                        `<div class="time-slot">
                            <strong>${slot.name}</strong><br>
                            <small>${slot.start_time.slice(0,5)} - ${slot.end_time.slice(0,5)}</small>
                        </div>`
                    ).join('');
                } else {
                    status.innerHTML = `<div class="status error">‚ùå Expected 24 slots, got ${slots.length}</div>`;
                }
            } catch (error) {
                status.innerHTML = `<div class="status error">‚ùå ${error.message}</div>`;
            }
        }

        async function addTeacher() {
            const name = document.getElementById('teacher-name').value;
            const day = document.getElementById('teacher-day').value;
            const status = document.getElementById('teacher-status');
            
            if (!name.trim()) {
                status.innerHTML = '<div class="status error">Please enter teacher name</div>';
                return;
            }
            
            status.innerHTML = '<div class="status info">Adding teacher...</div>';
            
            try {
                const teacher = await apiRequest(`/weekly/templates/${currentTemplateId}/teachers`, {
                    method: 'POST',
                    body: JSON.stringify({
                        name: name.trim(),
                        day_of_week: parseInt(day),
                        availability: [1, 2, 3, 4, 5, 6, 7, 8], // Morning availability
                        color_keyword: 'blue'
                    })
                });
                
                status.innerHTML = `<div class="status success">‚úÖ Added teacher: ${teacher.name}</div>`;
                document.getElementById('teacher-name').value = '';
                loadTeachersByDay(); // Refresh the view
            } catch (error) {
                status.innerHTML = `<div class="status error">‚ùå ${error.message}</div>`;
            }
        }

        async function loadTeachersByDay() {
            const day = document.getElementById('view-day').value;
            const container = document.getElementById('teachers-by-day');
            
            if (!day) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = '<div class="loading">Loading...</div>';
            
            try {
                const teachers = await apiRequest(`/weekly/templates/${currentTemplateId}/teachers/${day}`);
                
                if (teachers.length > 0) {
                    container.innerHTML = `
                        <h4>Teachers for ${['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][day]}:</h4>
                        ${teachers.map(t => `
                            <div style="background: #f3f4f6; padding: 10px; margin: 5px 0; border-radius: 4px;">
                                <strong>${t.name}</strong><br>
                                <small>Available slots: ${t.availability.length}</small>
                            </div>
                        `).join('')}
                    `;
                } else {
                    container.innerHTML = `<div class="status info">No teachers scheduled for this day</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="status error">‚ùå ${error.message}</div>`;
            }
        }

        async function generateWeeklyInstance() {
            const date = document.getElementById('week-date').value;
            const status = document.getElementById('instance-status');
            
            if (!date) {
                status.innerHTML = '<div class="status error">Please select a date</div>';
                return;
            }
            
            status.innerHTML = '<div class="status info">Generating weekly instance...</div>';
            
            try {
                const instance = await apiRequest(`/weekly/templates/${currentTemplateId}/generate-instance`, {
                    method: 'POST',
                    body: JSON.stringify({ weekStartDate: date })
                });
                
                status.innerHTML = `<div class="status success">‚úÖ Generated weekly schedule for week of ${date}</div>`;
            } catch (error) {
                status.innerHTML = `<div class="status error">‚ùå ${error.message}</div>`;
            }
        }

        // Auto-load on page load
        window.onload = function() {
            testBackend();
            loadTemplates();
        };
    </script>
</body>
</html>